{% extends 'chatlab/chatlab_base.html' %}
{% load static %}

{% block content %}
<section id="content" class="mx-16">
    <header class="page-header">
        <h1>Welcome to ChatLab</h1>
        {% if user.is_authenticated %}
            <form method="get" action="{% url 'chatlab:create_simulation' %}" class="start-form">
                <div
                    class="dropdown-wrapper"
                    x-data="modifierSelector()"
                    x-init="init()"
                    x-id="['modifier-tray']"
                    @click.away="closeTray()"
                    @keydown.escape.window="closeTray()"
                >
                    <div class="button-group">
                        <button type="submit" class="btn pri sm">Begin New Simulation</button>
                        <button
                            type="button"
                            class="btn sm"
                            @click="toggleTray()"
                            :aria-expanded="modifierTrayOpen.toString()"
                            :aria-controls="$id('modifier-tray')"
                        >
                            â–¼
                        </button>
                    </div>

                    <div
                        x-ref="modifierTray"
                        :id="$id('modifier-tray')"
                        class="modifier-tray"
                        x-show="modifierTrayOpen"
                        x-trap.noscroll="modifierTrayOpen"
                        x-transition.opacity.scale.origin.top.right
                        x-cloak
                        role="group"
                        tabindex="-1"
                        @keydown.arrow-down.prevent="focusNext()"
                        @keydown.arrow-up.prevent="focusPrevious()"
                        @keydown.home.prevent="focusFirst()"
                        @keydown.end.prevent="focusLast()"
                    >
                        <template x-for="group in modifierGroups" :key="group.group">
                            <fieldset x-show="group.group !== 'Feedback'" class="modifier-group">
                                <legend x-text="group.group" class="modifier-legend"></legend>
                                <template x-for="mod in group.modifiers" :key="mod.key">
                                    <label class="modifier-option">
                                        <input type="checkbox" :value="mod.key" x-model="selected">
                                        <span x-text="mod.description"></span>
                                    </label>
                                </template>
                            </fieldset>
                        </template>
                    </div>

                    <template x-for="mod in selected" :key="mod">
                        <input type="hidden" name="modifier" :value="mod">
                    </template>
                </div>
            </form>
        {% endif %}
    </header>

    {% if user.is_authenticated %}
        {% include 'chatlab/partials/simulation_history_base.html' %}
    {% endif %}

</section>

{% endblock content %}

{% block scripts %}
{{ block.super }}
<script>
function modifierSelector() {
    return {
        modifierTrayOpen: false,
        selected: [],
        modifierGroups: [],
        init() {
            this.fetchModifierGroups();
            this.$watch('modifierTrayOpen', (isOpen) => {
                if (isOpen) {
                    this.$nextTick(() => {
                        if (!this.focusFirst()) {
                            this.$refs.modifierTray?.focus();
                        }
                    });
                }
            });
        },
        toggleTray() {
            this.modifierTrayOpen = !this.modifierTrayOpen;
        },
        closeTray() {
            this.modifierTrayOpen = false;
        },
        focusableOptions() {
            return Array.from(this.$refs.modifierTray?.querySelectorAll('input[type="checkbox"]') || []);
        },
        focusFirst() {
            return this.setFocusIndex(0);
        },
        focusLast() {
            return this.setFocusIndex(this.focusableOptions().length - 1);
        },
        focusNext() {
            const options = this.focusableOptions();
            if (!options.length) return false;
            const currentIndex = options.indexOf(document.activeElement);
            const targetIndex = currentIndex < 0 ? 0 : (currentIndex + 1) % options.length;
            return this.setFocusIndex(targetIndex);
        },
        focusPrevious() {
            const options = this.focusableOptions();
            if (!options.length) return false;
            const currentIndex = options.indexOf(document.activeElement);
            const targetIndex = currentIndex <= 0 ? options.length - 1 : currentIndex - 1;
            return this.setFocusIndex(targetIndex);
        },
        setFocusIndex(index) {
            const options = this.focusableOptions();
            const option = options[index];
            if (option) {
                option.focus();
                return true;
            }
            return false;
        },
        async fetchModifierGroups() {
            try {
                const response = await fetch("{% url 'graphql' %}", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": document.querySelector('meta[name="csrf-token"]')?.content
                    },
                    body: JSON.stringify({
                        query: `
                            query {
                                modifierGroups(groups: ["ClinicalScenario", "ClinicalDuration"]) {
                                    group
                                    description
                                    modifiers {
                                        key
                                        description
                                    }
                                }
                            }
                        `
                    })
                });
                const result = await response.json();
                this.modifierGroups = result?.data?.modifierGroups || [];
            } catch (error) {
                console.error("Failed to load modifier groups", error);
            }
        }
    }
}
</script>
{% endblock scripts %}