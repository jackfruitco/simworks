{% extends 'accounts/accounts_base.html' %}
{% load static %}

{% block content %}
<div class="invite-container" x-data="{
    viewMode: 'list',
    page: 1,
    noMore: false,
    claimedFilter: '',
    expiredFilter: '',
    invitedByFilter: [],
    init() {
        ['viewMode', 'claimedFilter', 'expiredFilter', 'invitedByFilter'].forEach((key) => {
            this.$watch(key, () => this.refreshList());
        });
    },
    htmxVals(pageNumber) {
        return JSON.stringify({
            page: pageNumber,
            view_mode: this.viewMode,
            claimed: this.claimedFilter,
            expired: this.expiredFilter,
            invited_by: this.invitedByFilter,
        });
    },
    refreshList() {
        this.page = 1;
        this.noMore = false;
        this.$dispatch('filters-changed');
    },
    clearFilters() {
        this.claimedFilter = '';
        this.expiredFilter = '';
        this.invitedByFilter = [];
    },
    handleAfterSwap(event) {
        if (event.detail.xhr && event.detail.xhr.responseText.trim() !== '') {
            this.page++;
        } else {
            this.noMore = true;
        }
    }
}" x-init="init()">
    <h1>All Invitations</h1>

    <div class="invite-controls mb-16">
        <div class="invite-filter-grid">
            <select class="filter-input" x-model="claimedFilter">
                <option value="">All</option>
                <option value="true">Claimed</option>
                <option value="false">Unclaimed</option>
            </select>
            <select class="filter-input" x-model="expiredFilter">
                <option value="">All</option>
                <option value="true">Expired</option>
                <option value="false">Active</option>
            </select>
            <select class="filter-input" multiple x-model="invitedByFilter">
                <template x-for="inviter in {{ inviter_choices|safe }}">
                    <option :value="inviter" x-text="inviter"></option>
                </template>
            </select>
        </div>

        <div class="invite-actions">
            <button class="btn pri sm" @click="viewMode = viewMode === 'list' ? 'grid' : 'list'">
                Switch to <span x-text="viewMode === 'list' ? 'Tile' : 'List'"></span> View
            </button>
            <button class="btn ghost sm" @click="clearFilters()">
                Clear Filters
            </button>
        </div>
    </div>

    <div
        id="invite-list"
        hx-get="/accounts/invitations/list/"
        hx-trigger="load, filters-changed from:closest .invite-container"
        hx-target="#invite-list"
        hx-swap="innerHTML"
        :hx-vals="htmxVals(1)"
    >
    </div>

    <div
        id="pagination-loader"
        class="mt-16 mx-auto center"
        :hx-get="`/accounts/invitations/list/?page=${page + 1}&view_mode=${viewMode}&claimed=${claimedFilter}&expired=${expiredFilter}&${invitedByFilter.map(i => `invited_by=${i}`).join('&')}`"
        hx-trigger="revealed"
        hx-target="#invite-list"
        hx-swap="beforeend"
        hx-on:htmx:afterSwap="if ($event.detail.xhr && $event.detail.xhr.responseText.trim() !== '') { page++; } else { noMore = true; }"
        x-show="!noMore"
    >
        <button class="btn pri sm" disabled>Loading more invitations...</button>
    </div>
</div>
{% endblock %}
